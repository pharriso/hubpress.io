= Call Ansible Tower from ServiceNow


In this post we will look at how we can call Ansible Tower from ServiceNow as part of a ServiceNow Catalog Request. This use case allows us to hand off automation capabilities to end users whilst going through approval processes in ServiceNow.

In this example, I have a job template in Ansible Tower that will manage the membership of a node within an F5 loadbalancer pool. The job expects the user to input the name of the node that should be managed and the state it should be in - either enabled or forced_offline. This input from the user needs to be passed into Ansible Tower as extra variables so that the automation job can run succesfully. 

*NOTE* I am not a ServiceNow developer and this is definitely not a tutorial in how best to use ServiceNow. This is something that I had to work out for a demo around Ansible Tower.

=== Ansible Tower Job Template

In Ansible Tower, I already have my job template defined. Make a note of the job ID which is displayed in the URL. In the following example, the job ID is 10 - https://tower.example.com/#/templates/job_template/10

To allow extra variables to be passed into the Ansibe job execution, I need to enable *Prompt on launch* for *extra variables* as per the screenshot below. 

image::https://cloudautomation.pharriso.co.uk/images/snow_tower_job_template.png[]

=== ServiceNow Outbound REST Message

The first thing we need to configure in ServiceNow, is an Outbound REST message. This defines how it will connect to the Ansible Tower API to launch a job. This includes the API call, credentials and any extra variables we might want to pass from ServiceNow to Ansible Tower.  

In ServiceNow, navigate to *System Web Services -> Outbound -> REST Message* and click *New*.

Enter a name and the URL for the REST endpoint. This should be your Ansible Tower URL with the job ID that you want to launch.

image::https://cloudautomation.pharriso.co.uk/images/snow_rest_name.png[]

Set the *Authentication type* to *basic* and then click on the magnifying glass next to *Basic Auth profile*. Click *New* and enter a name for credential & the username and password to authenticate to Tower.

image::https://cloudautomation.pharriso.co.uk/images/snow_cred.png[]

Next set the Content-Type by selecting the *HTTP Request* tab and then adding a new *HTTP Header*.

image::https://cloudautomation.pharriso.co.uk/images/snow_endpoint_http_request.png[]

Click submit and then go back into your REST Message. As mentioned earlier, I want to pass variables from ServiceNow to Ansible Tower so I can use them in my Ansible automation. To do this, I need to add some content to the HTTP Post. Under *HTTP Methods* click *New* and add the details for our POST Request.  The *HTTP Method* needs to be *POST* and the *Endpoint* needs to be the url for the job we are launching.

image::https://cloudautomation.pharriso.co.uk/images/snow_post.png[]

Now under the *HTTP Request* tab, add a new *HTTP Query Parameter* with a *Name* of *Content* and a *Value* which contains the variable data I will pass to Tower. In my example:

....
{"extra_vars": { "member_name": "${f5_member}", "snow_request": "${snow_request}", "member_state": "${f5_member_state}" } }
....

Note the *${snow_request}* variable here. We will come back to that later.

The *HTTP Query Parameter* should look as follows.

image::https://cloudautomation.pharriso.co.uk/images/snow_extra_vars.png[]

Now we have defined how ServiceNow will make an API call to Ansible Tower. We need to create a workflow next to define how this API call will be triggered.

=== ServiceNow Workflow

In ServiceNow, navigate to *Workflow -> Editor*. Select *New Workflow*. Name the workflow and set the table to *Requested Item [sc_req_item]*. Press submit and you will be taken into the workflow design canvas.

image::https://cloudautomation.pharriso.co.uk/images/snow_workflow_name.png[]

Delete the connector between Begin and End. Then Select the *Core* tab in the right hand pane. Under *Utilities*, drag the *Run Script* object onto the workflow canvas. Name the script and then paste the script contents in.

----
try { 
 var r = new sn_ws.RESTMessageV2('Tower Job Launch', 'F5 Member Job'); 
 r.setStringParameterNoEscape('f5_member', current.variables.f5_member);
 r.setStringParameterNoEscape('f5_member_state', current.variables.f5_member_state);
 r.setStringParameterNoEscape('snow_request', current.request.number);

 var response = r.execute();
 var responseBody = response.getBody();
 var httpStatus = response.getStatusCode();
}
catch(ex) {
 var message = ex.message;
}

----








=== ServiceNow Service Catalog

Now that we have defined out outbound REST call and our workflow, we can add a Service Catalog item to expose this to end users. In ServiceNow, navigate to *Service Catalog -> Catalog Definitions -> Maintain Items*. Click on *New* and enter a name for the Service Catalog item. In the *Process Engine* tab, search for your workflow.

image::https://cloudautomation.pharriso.co.uk/images/snow_service_request_workflow.png[]

Now we can define the information we want to prompt the user for which will be passed to Ansible Tower as variables. Within your Catalog Item, navigate to the *Variables* tab at the bottom of the screen. Click *New* to define a new variable.

Select the question *Type* e.g. single line text or multi-choice. Then enter the question you want the user to see in the Catalog item in the *Question* field. In the *Name* field, enter the name of the variable that you want to pass to Tower.

image::https://cloudautomation.pharriso.co.uk/images/snow_sc_var.png[]

For multi-choice variables, you need to add *Question Choices* at the bottom of this screen. The *Text* being what you want the user to see on the form and the *Value* being the value of the variable that will be passed to Tower.

image::https://cloudautomation.pharriso.co.uk/images/snow_sc_question_choices.png[]






