= Call Ansible Tower from ServiceNow


In this post we will look at how we can call Ansible Tower from ServiceNow as part of a catalog request. This use case allows us to hand off automation capabilities to end users whilst allowing them to consume from.

=== Ansible Tower Job Template



=== ServiceNow Outbound REST Message

First we need to configure an Outbound REST message in ServiceNow to define how it will connect to the Ansible Tower API to launch a job. This includes the API call, credentials and any extra variables we might want to pass from ServiceNow to Ansible Tower. This is especially useful if we want to prompt the user for information in the ServiceNow Service Catalog that will be passed into the Automation execution. 

In ServiceNow, navigate to *System Web Services -> Outbound -> REST Message* and click *New*.

Enter a name and the URL for the REST endpoint. This should be your Ansible Tower URL with the job ID that you want to launch.

image::https://cloudautomation.pharriso.co.uk/images/snow_rest_name.png[]

Set the *Authentication type* to *basic* and then click on the magnifying glass next to *Basic Auth profile*. Click *New* and enter a name for credential & the username and password to authenticate to Tower.

image::https://cloudautomation.pharriso.co.uk/images/snow_cred.png[]

Next set the Content-Type by selecting the *HTTP Request* tab and then adding a new *HTTP Header*.

image::https://cloudautomation.pharriso.co.uk/images/snow_endpoint_http_request.png[]

As mentioned earlier, I want to pass variables from ServiceNow to Ansible Tower so I can use them during in my automation. To do this, I need to add some content to the HTTP Post. Under *HTTP Methods* click *New* and add the details for our POST Request.  The *HTTP Method* needs to be *POST* and the *Endpoint* needs to be the url for the job we are launching.

image::https://cloudautomation.pharriso.co.uk/images/snow_post.png[]

Now under the *HTTP Request* tab, add a new *HTTP Query Parameter* with a *Name* of *Content* and a *Value* which contains the variable data I will pass to Tower. In my example - 

....
{"extra_vars": { "member_name": "${f5_member}", "snow_request": "${snow_request}", "member_state": "${f5_member_state}" } }
....

The *HTTP Query Parameter* should look as follows.

image::https://cloudautomation.pharriso.co.uk/images/snow_extra_vars.png[]

=== ServiceNow Workflow

=== ServiceNow Service Catalog

Now that we have defined out outbound REST call and our workflow, we can add a Service Catalog item to expose this to end users. In ServiceNow, navigate to *Service Catalog -> Catalog Definitions -> Maintain Items*. Click on *New* and enter a name for the Service Catalog item. In the *Process Engine* tab, search for your workflow.

image::https://cloudautomation.pharriso.co.uk/images/snow_service_request_workflow.png[]

Now we can define the information we want to prompt the user for which will be passed to Ansible Tower as variables. Within your Catalog Item, navigate to the *Variables* tab at the bottom of the screen. Click *New* to define a new variable.

Select the question *Type* e.g. single line text or multi-choice. Then enter the question you want the user to see in the Catalog item in the *Question* field. In the *Name* field, enter the name of the variable that you want to pass to Tower.

image::https://cloudautomation.pharriso.co.uk/images/snow_sc_var.png[]

For multi-choice variables, you need to add *Question Choices* at the bottom of this screen. The *Text* being what you want the user to see on the form and the *Value* being the value of the variable that will be passed to Tower.

image::https://cloudautomation.pharriso.co.uk/images/snow_sc_question_choices.png[]






